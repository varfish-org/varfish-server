# Security controls for Dependabot PRs
# Prevents auto-merge and adds security checks
name: Dependabot Security Controls

on:
  pull_request:
    branches:
      - main
      - berlin

jobs:
  dependabot-security:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Check if npm dependency update
        id: check_npm
        run: |
          if git diff --name-only "origin/${{ github.base_ref }}...HEAD" | grep -q "frontend/package"; then
            echo "is_npm=true" >> $GITHUB_OUTPUT
            echo "::warning::This is an npm dependency update - requires manual security review"
          else
            echo "is_npm=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Block auto-merge for npm updates
        if: steps.check_npm.outputs.is_npm == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **NPM Dependency Update - Manual Review Required**\n\n' +
                    'This PR updates npm dependencies. Due to recent npm supply chain attacks, ' +
                    'this PR requires manual security review before merging.\n\n' +
                    '**Security Checklist:**\n' +
                    '- [ ] Review the changed packages for known vulnerabilities\n' +
                    '- [ ] Check for suspicious postinstall scripts\n' +
                    '- [ ] Verify package authenticity and maintainer reputation\n' +
                    '- [ ] Run `./utils/scan-npm-compromise.sh` locally\n' +
                    '- [ ] Review npm audit output\n\n' +
                    '**Do not enable auto-merge for this PR.**'
            });
            
            // Disable auto-merge if it was enabled
            if (context.payload.pull_request && context.payload.pull_request.node_id) {
              try {
                await github.graphql(`
                  mutation($pullRequestId: ID!) {
                    disablePullRequestAutoMerge(input: {pullRequestId: $pullRequestId}) {
                      pullRequest {
                        autoMergeRequest {
                          enabledAt
                        }
                      }
                    }
                  }
                `, {
                  pullRequestId: context.payload.pull_request.node_id
                });
                console.log('Auto-merge disabled successfully');
              } catch (error) {
                console.log('Failed to disable auto-merge (may not be enabled):', error.message);
              }
            } else {
              console.log('Pull request node_id not available, skipping auto-merge disable');
            }
      
      - name: Run npm audit
        if: steps.check_npm.outputs.is_npm == 'true'
        run: |
          cd frontend
          npm audit --production || echo "::warning::npm audit found vulnerabilities"
          
      - name: Comment audit results
        if: steps.check_npm.outputs.is_npm == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            try {
              const auditOutput = execSync('cd frontend && npm audit --json', { encoding: 'utf-8' });
              const audit = JSON.parse(auditOutput);
              const criticalCount = audit.metadata.vulnerabilities.critical || 0;
              const highCount = audit.metadata.vulnerabilities.high || 0;
              
              if (criticalCount > 0 || highCount > 0) {
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `ðŸš¨ **npm audit found ${criticalCount} critical and ${highCount} high severity vulnerabilities!**\n\n` +
                        `Run \`cd frontend && npm audit\` for details.`
                });
              }
            } catch (error) {
              console.log('npm audit check completed with warnings');
            }
