# Security controls for npm dependencies
# Scans all PRs for npm security issues and blocks Dependabot auto-merge
name: NPM Security Check

on:
  pull_request:
    branches:
      - main
      - berlin

jobs:
  npm-security:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Need full history for accurate diff
      
      - name: Check if npm dependency update
        id: check_npm
        run: |
          if git diff --name-only "origin/${{ github.base_ref }}...HEAD" | grep -q "frontend/package"; then
            echo "is_npm=true" >> "$GITHUB_OUTPUT"
            echo "::warning::This PR modifies npm dependencies - running security checks"
          else
            echo "is_npm=false" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Post security warning for npm updates
        if: steps.check_npm.outputs.is_npm == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const isDependabot = context.actor === 'dependabot[bot]';
            const warningMessage = isDependabot
              ? 'âš ï¸ **NPM Dependency Update - Manual Review Required**\n\n' +
                'This Dependabot PR updates npm dependencies. Due to recent npm supply chain attacks, ' +
                'this PR requires manual security review before merging.\n\n' +
                '**Security Checklist:**\n' +
                '- [ ] Review the changed packages for known vulnerabilities\n' +
                '- [ ] Check for suspicious postinstall scripts\n' +
                '- [ ] Verify package authenticity and maintainer reputation\n' +
                '- [ ] Run `./utils/scan-npm-compromise.sh` locally\n' +
                '- [ ] Review npm audit output\n\n' +
                '**Do not enable auto-merge for this PR.**'
              : 'ðŸ”’ **NPM Security Check**\n\n' +
                'This PR modifies npm dependencies. Security scan results will be posted below.\n\n' +
                '**Reminder:**\n' +
                '- Review `npm audit` output for vulnerabilities\n' +
                '- Check the security scan report artifact\n' +
                '- Verify package authenticity before merging';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: warningMessage
            });
            
            // Disable auto-merge only for Dependabot PRs
            if (isDependabot && context.payload.pull_request && context.payload.pull_request.node_id) {
              try {
                await github.graphql(`
                  mutation($pullRequestId: ID!) {
                    disablePullRequestAutoMerge(input: {pullRequestId: $pullRequestId}) {
                      pullRequest {
                        autoMergeRequest {
                          enabledAt
                        }
                      }
                    }
                  }
                `, {
                  pullRequestId: context.payload.pull_request.node_id
                });
                console.log('Auto-merge disabled successfully');
              } catch (error) {
                console.log('Failed to disable auto-merge (may not be enabled):', error.message);
              }
            }
      
      - name: Run npm audit
        if: steps.check_npm.outputs.is_npm == 'true'
        run: |
          cd frontend
          npm audit --production || echo "::warning::npm audit found vulnerabilities"
          
      - name: Comment audit results
        if: steps.check_npm.outputs.is_npm == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            try {
              const auditOutput = execSync('cd frontend && npm audit --json', { encoding: 'utf-8' });
              const audit = JSON.parse(auditOutput);
              const criticalCount = audit.metadata.vulnerabilities.critical || 0;
              const highCount = audit.metadata.vulnerabilities.high || 0;
              
              if (criticalCount > 0 || highCount > 0) {
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `ðŸš¨ **npm audit found ${criticalCount} critical and ${highCount} high severity vulnerabilities!**\n\n` +
                        `Run \`cd frontend && npm audit\` for details.`
                });
              }
            } catch (error) {
              console.log('npm audit check completed with warnings');
            }
